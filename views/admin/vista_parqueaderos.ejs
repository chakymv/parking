<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title><%= titulo || 'Vista Parqueaderos' %></title>
  <link rel="stylesheet" href="/admin/css/estilo.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card-parqueadero {
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    .celda-box {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
      font-size: 0.85em;
      background-color: #ffffff;
    }
    .celda-box.ocupado {
      background-color: #f8d7da;
      border-color: #dc3545;
    }
    .zona-bloque {
      margin-bottom: 20px;
    }
    .zona-resumen {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <%- include('header') %>
  <main>
    <div class="contenido-principal">
      <h1 class="centrar">Vista General de Parqueaderos</h1>
      <p class="centrar">Cada parqueadero con sus zonas y celdas agrupadas. Estado visual y ocupaciÃ³n.</p>
      <hr class="linea-windows">

      <div class="mb-4 centrar">
        <label for="parqueadero-select" class="form-label"><strong>Seleccionar Parqueadero</strong></label>
        <select id="parqueadero-select" class="form-select w-50 mx-auto">
          <option value="todos">Todos</option>
          <% parqueaderos.forEach(p => { %>
            <option value="<%= p.id %>"><%= p.nombre %> (<%= p.codigo %>)</option>
          <% }) %>
        </select>
      </div>

      <% parqueaderos.forEach(p => { %>
        <div class="caja-oscura card-parqueadero" data-id="<%= p.id %>">
          <div class="columnas">
            <div class="columna-izquierda">
              <h2 style="margin-bottom: 5px;"><%= p.nombre %> <small>(<%= p.codigo %>)</small></h2>
              <p><strong>Tipo:</strong> <%= p.tipo %> â€” <strong>Capacidad:</strong> <%= p.capacidad %></p>
            </div>
          </div>

          <% 
            const zonasAsociadas = zonas.filter(z =>
              celdas.some(c => c.zona_id === z.id && c.parqueadero_id === p.id)
            );
          %>

          <% zonasAsociadas.forEach(zona => { 
              const celdasZona = celdas.filter(c => c.zona_id === zona.id && c.parqueadero_id === p.id);
              const libres = celdasZona.filter(c => (c.estado || '').toLowerCase() === 'libre').length;
              const ocupadas = celdasZona.filter(c => (c.estado || '').toLowerCase() === 'ocupado').length;
          %>
            <div class="zona-bloque">
              <h4><i class="fa-solid fa-layer-group me-1"></i> <%= zona.nombre %></h4>
              <div class="zona-resumen">
                ðŸŸ© <%= libres %> libres â€” ðŸŸ¥ <%= ocupadas %> ocupadas
              </div>

              <div class="celdas-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;">
                <% celdasZona.forEach(celda => {
                    const estado = (celda.estado || '').toLowerCase();
                    const clase = estado === 'libre' ? '' : 'ocupado';
                %>
                  <div class="celda-box <%= clase %>">
                    <strong>Celda <%= celda.id %></strong><br>
                    <small><%= celda.tipo %></small><br>

                    <% if (estado === 'ocupado' && celda.placa && celda.numero_documento) { %>
                      <span style="color: #000;">ðŸš— <%= celda.placa %></span><br>
                      <span style="color: #000;">ðŸªª CÃ©dula: <%= celda.numero_documento %></span>
                    <% } else { %>
                      <span class="text-muted">Disponible</span>
                    <% } %>
                  </div>
                <% }) %>
              </div>
            </div>
          <% }) %>

          <% if (zonasAsociadas.length === 0) { %>
            <div class="alerta-error centrar-texto mt-3">
              ðŸš§ Este parqueadero aÃºn no tiene zonas ni celdas asignadas.
            </div>
          <% } %>
        </div>
      <% }) %>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('parqueadero-select').addEventListener('change', function() {
      const seleccionado = this.value;
      document.querySelectorAll('.card-parqueadero').forEach(card => {
        const pid = card.getAttribute('data-id');
        if (seleccionado === 'todos' || pid === seleccionado) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
